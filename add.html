<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Add Rx ‚Ä¢ LTC</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    :root{
      --bg:#f5f5f7;
      --card:#ffffff;
      --ink:#1d1d1f;
      --muted:#6e6e73;
      --blue:#0071e3;
      --green:#22c55e;
      --hair:rgba(0,0,0,.08);
      --radius:26px;
      --shadow:0 18px 40px rgba(0,0,0,.08);
      --shadow2:0 10px 26px rgba(0,0,0,.10);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:-apple-system,BlinkMacSystemFont,"SF Pro Text",system-ui,sans-serif;
      background:var(--bg);
      color:var(--ink);
    }
    .wrap{max-width:980px;margin:0 auto;padding:24px 18px 40px}
    .topbar{display:flex;justify-content:space-between;gap:16px;align-items:flex-start}
    .brand{
      font-weight:900;
      font-size:clamp(1.8rem,2.5vw,2.6rem);
      background:linear-gradient(90deg,#0071e3,#34c759);
      -webkit-background-clip:text;background-clip:text;color:transparent;
      letter-spacing:-.02em;
    }
    .sub{color:var(--muted);margin-top:4px}
    .nav{
      display:flex;gap:10px;flex-wrap:wrap;align-items:center;
      margin:12px 0 14px;
    }
    .navbtn{
      display:flex;align-items:center;gap:10px;
      border:1px solid var(--hair);
      background:var(--card);
      border-radius:999px;
      padding:10px 14px;
      box-shadow:var(--shadow2);
      cursor:pointer;
      font-weight:900;
      color:var(--ink);
      text-decoration:none;
    }
    .pill{
      width:34px;height:34px;border-radius:12px;
      display:flex;align-items:center;justify-content:center;
      background:rgba(0,113,227,.10);
      color:var(--blue);
      font-size:1.1rem;
    }

    .card{
      background:var(--card);
      border:1px solid var(--hair);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .head{
      padding:16px 18px;
      border-bottom:1px solid rgba(0,0,0,.08);
      background:linear-gradient(180deg,rgba(0,113,227,.08),#fff);
    }
    .title{font-weight:1000;font-size:1.15rem}
    .hint{color:var(--muted);margin-top:4px}

    .form{
      padding:16px 18px;
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:12px;
    }
    label{
      display:block;
      color:var(--muted);
      font-weight:1000;
      font-size:.78rem;
      text-transform:uppercase;
      letter-spacing:.08em;
      margin-bottom:6px;
    }
    input,select,textarea{
      width:100%;
      border:1px solid var(--hair);
      background:#fff;
      padding:12px 14px;
      border-radius:16px;
      outline:none;
      box-shadow:0 10px 22px rgba(0,0,0,.06);
    }
    textarea{min-height:110px;resize:vertical}
    .full{grid-column:1 / -1}

    .bot{
      padding:14px 18px;
      border-top:1px solid rgba(0,0,0,.08);
      display:flex;justify-content:space-between;gap:12px;flex-wrap:wrap;align-items:center;
      background:rgba(245,245,247,.6);
    }
    .btn{
      border:1px solid rgba(0,0,0,.10);
      background:#fff;
      padding:12px 14px;
      border-radius:999px;
      cursor:pointer;
      font-weight:1000;
      box-shadow:var(--shadow2);
      display:flex;align-items:center;gap:10px;
    }
    .btn.primary{
      border-color:rgba(0,113,227,.22);
      background:linear-gradient(180deg,rgba(0,113,227,.12),#fff);
    }
    .msg{
      border:1px solid rgba(0,0,0,.08);
      background:#fff;
      border-radius:16px;
      padding:10px 12px;
      box-shadow:0 12px 26px rgba(0,0,0,.10);
      color:var(--muted);
      max-width:660px;
    }
    .ok{color:var(--green);font-weight:1000}
    .warn{color:#f59e0b;font-weight:1000}

    @media (max-width:760px){
      .form{grid-template-columns:1fr}
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div>
        <div class="brand">Add Rx</div>
        <div class="sub">Writes a new row into <b>DispenseQueue</b>.</div>
      </div>
      <div class="sub" id="rt">‚Äî</div>
    </div>

    <div class="nav">
      <a class="navbtn" href="index.html"><span class="pill">‚Üê</span> Back to Dispense</a>
      <button class="navbtn" onclick="loadLookups()"><span class="pill">‚ú®</span> Load suggestions</button>
      <button class="navbtn" onclick="clearForm()"><span class="pill">üßπ</span> Clear</button>
    </div>

    <div class="card">
      <div class="head">
        <div class="title">New prescription</div>
        <div class="hint">Timing supports AM/PM/HS/NIGHT or BID/TID/QID (or ‚ÄúAM,PM‚Äù). Due date defaults to today.</div>
      </div>

      <div class="form">
        <div>
          <label>Resident (optional)</label>
          <input id="resident" list="residentList" placeholder="Room 101 / Resident name" />
          <datalist id="residentList"></datalist>
        </div>

        <div>
          <label>Entered by</label>
          <input id="enteredBy" placeholder="Nurse / staff name" />
        </div>

        <div class="full">
          <label>Medication (required)</label>
          <input id="medication" list="medList" placeholder="Drug + strength + form" />
          <datalist id="medList"></datalist>
        </div>

        <div class="full">
          <label>Instructions</label>
          <textarea id="instructions" placeholder="Directions / notes"></textarea>
        </div>

        <div>
          <label>Timing (required)</label>
          <select id="timing">
            <option value="">‚Äî Select ‚Äî</option>
            <option>AM</option>
            <option>NOON</option>
            <option>PM</option>
            <option>HS</option>
            <option>NIGHT</option>
            <option>BID</option>
            <option>TID</option>
            <option>QID</option>
            <option>AM,PM</option>
            <option>AM,NOON,PM</option>
            <option>AM,NOON,PM,HS</option>
          </select>
        </div>

        <div>
          <label>Due date</label>
          <input id="dueDate" type="date" />
        </div>
      </div>

      <div class="bot">
        <div style="display:flex;gap:10px;flex-wrap:wrap">
          <button class="btn primary" onclick="submitRx()"><span class="pill">‚ûï</span> Add to Queue</button>
          <button class="btn" onclick="clearForm()"><span class="pill">üßπ</span> Clear</button>
        </div>
        <div class="msg" id="msg">Ready.</div>
      </div>
    </div>
  </div>

<script>
/*** YOU MUST SET THESE ***/
const API_URL = "https://script.google.com/macros/s/AKfycbyoUMqa0N9B_6yTqA3bpKt4DfzUhamdvgkHw6TxaGYLUwWu72DLOnJ7sIEmNhoMSVCk/exec";
const API_KEY = "CHANGE_ME_TO_SOMETHING_SECRET";

const pad = n => String(n).padStart(2,"0");
const todayISO = () => {
  const d = new Date();
  return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
};
document.getElementById("dueDate").value = todayISO();
document.getElementById("rt").textContent = `Today: ${todayISO()}`;

function msg(text, cls=""){
  const el = document.getElementById("msg");
  el.className = "msg " + (cls||"");
  el.textContent = text;
}

/*** JSONP ***/
function jsonp(url){
  return new Promise((resolve, reject) => {
    const cb = "cb_" + Math.random().toString(36).slice(2);
    const sep = url.includes("?") ? "&" : "?";
    const full = url + sep + "callback=" + cb;

    const script = document.createElement("script");
    script.src = full;
    script.async = true;

    const timeout = setTimeout(() => {
      cleanup();
      reject(new Error("API timeout"));
    }, 20000);

    window[cb] = (data) => { cleanup(); resolve(data); };
    script.onerror = () => { cleanup(); reject(new Error("API load error")); };

    function cleanup(){
      clearTimeout(timeout);
      delete window[cb];
      script.remove();
    }
    document.head.appendChild(script);
  });
}
function api(action, params={}){
  const q = new URLSearchParams({ action, key: API_KEY, ...params }).toString();
  return jsonp(`${API_URL}?${q}`);
}

function clearForm(){
  document.getElementById("resident").value = "";
  document.getElementById("enteredBy").value = "";
  document.getElementById("medication").value = "";
  document.getElementById("instructions").value = "";
  document.getElementById("timing").value = "";
  document.getElementById("dueDate").value = todayISO();
  msg("Ready.");
}

async function loadLookups(){
  try{
    msg("Loading suggestions‚Ä¶");
    const res = await api("lookups", {});
    if (!res.ok) throw new Error(res.message || "Lookup failed");

    const residents = res.data?.residents || [];
    const meds = res.data?.medications || [];

    document.getElementById("residentList").innerHTML =
      residents.map(x=>`<option value="${String(x).replaceAll('"','&quot;')}"></option>`).join("");

    document.getElementById("medList").innerHTML =
      meds.map(x=>`<option value="${String(x).replaceAll('"','&quot;')}"></option>`).join("");

    msg(`Loaded ${residents.length} residents + ${meds.length} medications.`, "ok");
  } catch(e){
    msg("Error: " + e.message, "warn");
  }
}

async function submitRx(){
  const payload = {
    resident: document.getElementById("resident").value.trim(),
    enteredBy: document.getElementById("enteredBy").value.trim(),
    medication: document.getElementById("medication").value.trim(),
    instructions: document.getElementById("instructions").value.trim(),
    timing: document.getElementById("timing").value.trim(),
    dueDate: document.getElementById("dueDate").value.trim()
  };

  if (!payload.medication) return msg("Medication is required.", "warn");
  if (!payload.timing) return msg("Timing is required.", "warn");

  try{
    msg("Saving‚Ä¶");
    const res = await api("addRx", payload);
    if (!res.ok) throw new Error(res.message || "Save failed");
    msg(res.message || "Added.", "ok");
    clearForm();
  } catch(e){
    msg("Error: " + e.message, "warn");
  }
}

// Auto load suggestions once (optional)
loadLookups();
</script>
</body>
</html>
