<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Add Prescription</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    :root{
      --bg:#f5f5f7;
      --card-bg:#ffffff;
      --text-main:#1d1d1f;
      --text-sub:#6e6e73;
      --accent-blue:#0071e3;
      --accent-green:#22c55e;
      --shadow-soft:0 18px 40px rgba(0,0,0,.08);
      --shadow-mini:0 10px 26px rgba(0,0,0,.10);
      --radius:26px;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      font-family:-apple-system,BlinkMacSystemFont,"SF Pro Text",system-ui,sans-serif;
      background:var(--bg); color:var(--text-main);
    }
    a{color:var(--accent-blue);text-decoration:none}

    .header{padding:28px 7vw 14px;display:flex;justify-content:space-between;gap:16px;align-items:flex-start}
    .logo{
      font-size:clamp(1.8rem,2.6vw,2.6rem);
      font-weight:800;
      background:linear-gradient(90deg,#0071e3,#34c759);
      -webkit-background-clip:text;background-clip:text;color:transparent;
    }
    .right{text-align:right;font-size:.95rem;line-height:1.25}
    .right p:first-child{font-weight:700;margin-bottom:4px}
    .right p:last-child{color:var(--text-sub)}

    main{padding:0 7vw 34px}
    .headline{font-size:clamp(1.35rem,1.9vw,1.75rem);font-weight:700;margin:6px 0 14px}
    .headline span{color:var(--accent-blue)}

    .card{background:var(--card-bg);border-radius:var(--radius);box-shadow:var(--shadow-soft);overflow:hidden}
    .top{padding:16px 18px;border-bottom:1px solid rgba(0,0,0,.06);display:flex;justify-content:space-between;gap:12px;flex-wrap:wrap}
    .sub{color:var(--text-sub);font-size:.95rem;margin-top:6px}

    .form{
      padding:16px 18px 18px;
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:12px;
    }
    label{
      font-size:.78rem;color:var(--text-sub);
      text-transform:uppercase;letter-spacing:.08em;
      display:block;margin-bottom:6px;font-weight:800;
    }
    input,select,textarea{
      width:100%;
      border:1px solid rgba(0,0,0,.12);
      background:#fff;padding:11px 12px;border-radius:14px;outline:none;
    }
    textarea{min-height:110px;resize:vertical}
    .full{grid-column:1 / -1}

    .bottom{
      padding:14px 18px;
      border-top:1px solid rgba(0,0,0,.06);
      display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;align-items:center;
      background:rgba(245,245,247,.45);
    }
    .btns{display:flex;gap:10px;flex-wrap:wrap}
    .btn{
      border:1px solid rgba(0,0,0,.10);background:#fff;
      padding:11px 14px;border-radius:999px;cursor:pointer;
      font-weight:900;box-shadow:var(--shadow-mini);
    }
    .btn.primary{
      border-color:rgba(0,113,227,.22);
      background:linear-gradient(180deg,rgba(0,113,227,.10),#fff);
    }

    .msg{
      font-size:.95rem;color:var(--text-sub);
      padding:10px 12px;border-radius:14px;background:#fff;
      border:1px solid rgba(0,0,0,.08);
      box-shadow:0 8px 22px rgba(0,0,0,.06);
      max-width:760px;
    }
    .ok{color:var(--accent-green);font-weight:900}
    .warn{color:#b45309;font-weight:900}

    @media (max-width:720px){
      .header,main{padding-left:5vw;padding-right:5vw}
      .form{grid-template-columns:1fr}
    }
  </style>
</head>

<body>
  <div class="header">
    <div class="logo">Add Prescription</div>
    <div class="right">
      <p>Writes to your queue sheet</p>
      <p>Required: Medication + Timing</p>
    </div>
  </div>

  <main>
    <div class="headline"><span>New entry.</span> Add a prescription to dispense later.</div>

    <section class="card">
      <div class="top">
        <div>
          <div style="font-weight:900;font-size:1.05rem">New Rx</div>
          <div class="sub">Due date defaults to today. Timing supports AM/PM/HS or BID/TID/QID.</div>
        </div>
        <a class="btn" href="index.html">← Back to Dispense</a>
      </div>

      <div class="form">
        <div>
          <label>Resident / Room</label>
          <input id="resident" placeholder="Room 101 / Resident name" />
        </div>

        <div>
          <label>Entered By</label>
          <input id="enteredBy" placeholder="Nurse / staff name" />
        </div>

        <div class="full">
          <label>Medication (required)</label>
          <input id="medication" placeholder="Drug name + strength + form" />
        </div>

        <div class="full">
          <label>Instructions</label>
          <textarea id="instructions" placeholder="Directions / notes (optional)"></textarea>
        </div>

        <div>
          <label>Timing (required)</label>
          <select id="timing">
            <option value="">-- Select --</option>
            <option>AM</option>
            <option>NOON</option>
            <option>PM</option>
            <option>HS</option>
            <option>NIGHT</option>
            <option>BID</option>
            <option>TID</option>
            <option>QID</option>
            <option>AM,PM</option>
            <option>AM,NOON,PM</option>
            <option>AM,NOON,PM,HS</option>
          </select>
        </div>

        <div>
          <label>Due Date</label>
          <input id="dueDate" type="date" />
        </div>
      </div>

      <div class="bottom">
        <div class="btns">
          <button class="btn primary" onclick="submitRx()">Add to Queue</button>
          <button class="btn" onclick="clearForm()">Clear</button>
        </div>
        <div class="msg" id="msg">—</div>
      </div>
    </section>
  </main>

<script>
/*** SET THESE 2 VALUES ***/
const API_URL = "https://script.google.com/macros/s/AKfycbyoUMqa0N9B_6yTqA3bpKt4DfzUhamdvgkHw6TxaGYLUwWu72DLOnJ7sIEmNhoMSVCk/exec";
const API_KEY = "CHANGE_ME_TO_SOMETHING_SECRET";

function pad(n){ return String(n).padStart(2,"0"); }
function todayISO(){
  const d=new Date();
  return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
}
document.getElementById("dueDate").value = todayISO();

function setMsg(text, cls=""){
  const el=document.getElementById("msg");
  el.className="msg "+cls;
  el.textContent=text||"";
}

/*** JSONP ***/
function jsonp(url){
  return new Promise((resolve, reject) => {
    const cb = "cb_" + Math.random().toString(36).slice(2);
    const sep = url.includes("?") ? "&" : "?";
    const full = url + sep + "callback=" + cb;

    const script = document.createElement("script");
    script.src = full;
    script.async = true;

    const timeout = setTimeout(() => {
      cleanup();
      reject(new Error("API timeout"));
    }, 20000);

    window[cb] = (data) => { cleanup(); resolve(data); };
    script.onerror = () => { cleanup(); reject(new Error("API load error")); };

    function cleanup(){
      clearTimeout(timeout);
      delete window[cb];
      script.remove();
    }

    document.head.appendChild(script);
  });
}

function api(action, params={}){
  const q = new URLSearchParams({ action, key: API_KEY, ...params }).toString();
  return jsonp(`${API_URL}?${q}`);
}

function clearForm(){
  document.getElementById("resident").value="";
  document.getElementById("enteredBy").value="";
  document.getElementById("medication").value="";
  document.getElementById("instructions").value="";
  document.getElementById("timing").value="";
  document.getElementById("dueDate").value=todayISO();
  setMsg("—");
}

async function submitRx(){
  const payload = {
    resident: document.getElementById("resident").value.trim(),
    enteredBy: document.getElementById("enteredBy").value.trim(),
    medication: document.getElementById("medication").value.trim(),
    instructions: document.getElementById("instructions").value.trim(),
    timing: document.getElementById("timing").value.trim(),
    dueDate: document.getElementById("dueDate").value.trim()
  };

  if (!payload.medication) return setMsg("Medication is required.", "warn");
  if (!payload.timing) return setMsg("Timing is required.", "warn");

  try{
    setMsg("Saving…");
    const res = await api("addRx", payload);
    if (!res.ok) throw new Error(res.message || "Save failed");
    setMsg(res.message || "Saved.", "ok");
    clearForm();
  }catch(e){
    setMsg("Error: "+e.message, "warn");
  }
}
</script>
</body>
</html>
