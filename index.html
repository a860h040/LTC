<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>LTC Med Dispense</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    :root{
      --bg:#f5f5f7;
      --card:#ffffff;
      --ink:#111827;
      --sub:#6b7280;
      --blue:#0071e3;
      --green:#22c55e;
      --red:#ef4444;
      --line:rgba(0,0,0,.08);
      --shadow:0 18px 45px rgba(0,0,0,.10);
      --r:26px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:-apple-system,BlinkMacSystemFont,"SF Pro Text",system-ui,Segoe UI,Roboto,Arial,sans-serif;
      background:var(--bg);
      color:var(--ink);
    }

    /* header */
    .header{
      padding: 26px 6vw 14px;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:18px;
    }
    .brand{
      display:flex;align-items:center;gap:12px;
    }
    .brand h1{
      margin:0;
      font-size:clamp(1.6rem,2.3vw,2.2rem);
      font-weight:800;
      letter-spacing:-0.02em;
      background:linear-gradient(90deg,#0071e3,#22c55e);
      -webkit-background-clip:text;
      background-clip:text;
      color:transparent;
    }
    .brand p{margin:2px 0 0;color:var(--sub);font-size:.95rem}

    .headerRight{
      text-align:right;
      color:var(--sub);
      font-size:.92rem;
      line-height:1.3;
    }

    /* top tools */
    .wrap{padding: 10px 6vw 26px;}
    .panel{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--r);
      box-shadow:var(--shadow);
      overflow:hidden;
    }

    .topbar{
      padding:14px 16px;
      display:flex;
      flex-wrap:wrap;
      gap:12px;
      align-items:center;
      border-bottom:1px solid var(--line);
      background:linear-gradient(180deg,#fff, #fafafa);
    }

    .backBtn{
      display:flex;
      align-items:center;
      justify-content:center;
      width:44px;height:44px;
      border-radius:16px;
      border:1px solid var(--line);
      background:#111827;
      box-shadow:0 10px 26px rgba(0,0,0,.10);
      cursor:pointer;
      transition:transform .12s ease, box-shadow .12s ease;
    }
    .backBtn:hover{transform:translateY(-1px);box-shadow:0 14px 32px rgba(0,0,0,.14)}
    .backBtn:active{transform:scale(.98)}
    .backBtn img{width:22px;height:22px;object-fit:contain}

    .select, .input{
      border:1px solid var(--line);
      background:#fff;
      height:44px;
      padding:0 12px;
      border-radius:14px;
      font-size:.95rem;
      outline:none;
      min-width:160px;
    }
    .input{min-width:210px;flex:1}
    .hint{
      color:var(--sub);
      font-size:.88rem;
      margin-left:auto;
      white-space:nowrap;
    }

    /* table */
    table{
      width:100%;
      border-collapse:collapse;
    }
    th, td{
      padding:12px 14px;
      border-bottom:1px solid var(--line);
      font-size:.95rem;
      vertical-align:top;
    }
    th{
      font-size:.78rem;
      letter-spacing:.08em;
      text-transform:uppercase;
      color:#64748b;
      background:#fbfbfc;
    }
    td small{color:var(--sub)}
    .chk{width:42px;text-align:center}
    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background:#f9fafb;
      font-size:.85rem;
      color:#374151;
    }

    .footerbar{
      padding:14px 16px;
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
    }
    .btn{
      border:none;
      height:44px;
      padding:0 14px;
      border-radius:14px;
      cursor:pointer;
      font-weight:650;
      transition: transform .12s ease, box-shadow .12s ease, opacity .12s ease;
    }
    .btn:active{transform:scale(.99)}
    .btn.primary{background:var(--blue);color:#fff;box-shadow:0 14px 30px rgba(0,113,227,.22)}
    .btn.danger{background:#fff;color:#b91c1c;border:1px solid rgba(185,28,28,.35)}
    .btn.ghost{background:#111827;color:#fff}
    .status{
      color:#b45309;
      font-weight:700;
    }
    .ok{color:#047857}
    .err{color:#b91c1c}
    .muted{color:var(--sub);font-weight:500}

    /* floating add rx */
    .fab{
      position:fixed;right:16px;bottom:16px;
      height:56px;
      padding:0 18px;
      border-radius:18px;
      background:#111827;color:#fff;
      border:1px solid rgba(0,0,0,.08);
      box-shadow:0 18px 45px rgba(0,0,0,.18);
      display:flex;align-items:center;gap:10px;
      cursor:pointer;
      text-decoration:none;
      font-weight:750;
      z-index:999;
      transition:transform .12s ease, box-shadow .12s ease;
    }
    .fab:hover{transform:translateY(-1px);box-shadow:0 24px 60px rgba(0,0,0,.22)}
    .fab:active{transform:scale(.99)}
    .fabIcon{
      width:34px;height:34px;border-radius:14px;
      background:rgba(255,255,255,.10);
      display:flex;align-items:center;justify-content:center;
      font-size:20px;
    }

    @media (max-width:720px){
      .hint{display:none}
      .input{min-width: 100%}
      .select{min-width: 48%}
    }
  </style>
</head>

<body>
  <header class="header">
    <div class="brand">
      <div>
        <h1>LTC Dispense</h1>
        <p>Shows only meds due for the selected time window.</p>
      </div>
    </div>
    <div class="headerRight">
      <div><strong>Tip:</strong> Select AM / PM / HS etc.</div>
      <div>Then check items â†’ Dispense Selected</div>
    </div>
  </header>

  <main class="wrap">
    <section class="panel">
      <div class="topbar">
        <!-- Back icon (your github image) -->
        <button class="backBtn" id="goAdd" title="Add RX">
          <img src="sigler-500-white.png" alt="Back icon" />
        </button>

        <select class="select" id="timeSlot">
          <option value="AUTO">AUTO (based on current time)</option>
          <option value="AM">AM</option>
          <option value="NOON">NOON</option>
          <option value="PM">PM</option>
          <option value="HS">HS</option>
          <option value="NIGHT">NIGHT</option>
        </select>

        <input class="input" id="nurseName" placeholder="Nurse name (for log)" />
        <input class="input" id="search" placeholder="Search resident or medication..." />

        <div class="hint">AUTO: AM (06â€“11) Â· NOON (12â€“13) Â· PM (14â€“17) Â· HS (18â€“23) Â· NIGHT (00â€“05)</div>
      </div>

      <div style="overflow:auto">
        <table>
          <thead>
            <tr>
              <th class="chk"><input type="checkbox" id="checkAll" /></th>
              <th>Resident</th>
              <th>Medication</th>
              <th>Instructions</th>
              <th>Timing</th>
            </tr>
          </thead>
          <tbody id="rows">
            <tr><td colspan="5" class="muted">Loadingâ€¦</td></tr>
          </tbody>
        </table>
      </div>

      <div class="footerbar">
        <button class="btn primary" id="dispenseBtn">Dispense Selected</button>
        <button class="btn danger" id="clearBtn">Clear Selection</button>
        <span class="status" id="status"></span>
      </div>
    </section>
  </main>

  <a class="fab" href="add.html" title="Add RX">
    <span class="fabIcon">ï¼‹</span>
    Add RX
  </a>

  <script>
    // âœ… Put your Web App URL here (Google Apps Script deployed as Web App)
    // If you already have a GAS URL, paste it below.
    const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbxHqruOM0OncDT-ZGT7HqhkjklKU0rpg2-BpBiqk4iDsGD5EfxFcM-fd1-n2Y2vcUU/exec"; // <-- paste like: https://script.google.com/macros/s/XXXX/exec

    // Spreadsheet ID you gave
    const SPREADSHEET_ID = "17FXMcaJ2un_rhKKlYZbJR6yd2BDgISIM2k0z6iC9_O4";

    // expected sheet columns:
    // A: Resident | B: Medication | C: Instructions | D: TimingSlot (AM/PM/HS/NOON/NIGHT etc.)
    // Row is removed when dispensed
    const SHEET_NAME = "Dispense";

    const elRows = document.getElementById("rows");
    const elSlot = document.getElementById("timeSlot");
    const elSearch = document.getElementById("search");
    const elNurse = document.getElementById("nurseName");
    const elStatus = document.getElementById("status");
    const elCheckAll = document.getElementById("checkAll");

    document.getElementById("goAdd").addEventListener("click", () => {
      window.location.href = "add.html";
    });

    function autoSlot(){
      const h = new Date().getHours();
      if (h >= 6 && h <= 11) return "AM";
      if (h >= 12 && h <= 13) return "NOON";
      if (h >= 14 && h <= 17) return "PM";
      if (h >= 18 && h <= 23) return "HS";
      return "NIGHT";
    }

    let allData = []; // {rowIndex, resident, med, instr, timing}

    function setStatus(msg, cls=""){
      elStatus.className = "status " + cls;
      elStatus.textContent = msg || "";
    }

    function filterAndRender(){
      const slot = (elSlot.value === "AUTO") ? autoSlot() : elSlot.value;
      const q = elSearch.value.trim().toLowerCase();

      const show = allData.filter(x=>{
        const matchSlot = (String(x.timing || "").toUpperCase().includes(slot));
        const matchQ = !q || (x.resident.toLowerCase().includes(q) || x.med.toLowerCase().includes(q));
        return matchSlot && matchQ;
      });

      if (!show.length){
        elRows.innerHTML = `<tr><td colspan="5" class="muted">No meds due for this time slot.</td></tr>`;
        return;
      }

      elRows.innerHTML = show.map(item => `
        <tr>
          <td class="chk">
            <input type="checkbox" class="rowChk" data-row="${item.rowIndex}">
          </td>
          <td>${escapeHtml(item.resident)}</td>
          <td><strong>${escapeHtml(item.med)}</strong></td>
          <td><small>${escapeHtml(item.instr)}</small></td>
          <td><span class="pill">ðŸ•’ ${escapeHtml(item.timing)}</span></td>
        </tr>
      `).join("");
    }

    function escapeHtml(s){
      return String(s ?? "").replace(/[&<>"']/g, m => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
      }[m]));
    }

    async function api(action, payload){
      // If you host on GitHub, you use fetch to WEB_APP_URL
      if (!WEB_APP_URL){
        throw new Error("WEB_APP_URL is empty. Paste your deployed Google Apps Script Web App URL.");
      }
      const res = await fetch(WEB_APP_URL, {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({ action, spreadsheetId: SPREADSHEET_ID, sheetName: SHEET_NAME, ...payload })
      });
      const data = await res.json();
      if (!data.ok) throw new Error(data.error || "Unknown error");
      return data;
    }

    async function load(){
      try{
        setStatus("Loadingâ€¦");
        const out = await api("list_due", {});
        allData = out.items || [];
        filterAndRender();
        setStatus(`Loaded ${allData.length} items`, "ok");
      }catch(e){
        setStatus("Error: " + e.message, "err");
        elRows.innerHTML = `<tr><td colspan="5" class="err">Error: ${escapeHtml(e.message)}</td></tr>`;
      }
    }

    document.getElementById("clearBtn").addEventListener("click", ()=>{
      document.querySelectorAll(".rowChk").forEach(ch=>ch.checked=false);
      elCheckAll.checked=false;
      setStatus("Selection cleared", "muted");
    });

    elCheckAll.addEventListener("change", ()=>{
      const v = elCheckAll.checked;
      document.querySelectorAll(".rowChk").forEach(ch=>ch.checked=v);
    });

    document.getElementById("dispenseBtn").addEventListener("click", async ()=>{
      try{
        const nurse = elNurse.value.trim();
        if (!nurse) { setStatus("Enter nurse name first.", "err"); return; }

        const checked = Array.from(document.querySelectorAll(".rowChk:checked"))
          .map(ch => Number(ch.dataset.row))
          .filter(n => Number.isFinite(n));

        if (!checked.length){ setStatus("Select at least one medication.", "err"); return; }

        setStatus("Dispensingâ€¦");
        await api("dispense", { nurse, rowIndexes: checked });

        // remove from local array + re-render
        allData = allData.filter(x => !checked.includes(x.rowIndex));
        filterAndRender();
        setStatus("Dispensed and removed from sheet âœ…", "ok");
      }catch(e){
        setStatus("Error: " + e.message, "err");
      }
    });

    elSlot.addEventListener("change", filterAndRender);
    elSearch.addEventListener("input", filterAndRender);

    load();
  </script>
</body>
</html>
