<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>LTC Medication Dispense</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    :root{
      --bg:#f5f5f7;
      --card:#ffffff;
      --ink:#1d1d1f;
      --muted:#6e6e73;
      --blue:#0071e3;
      --green:#22c55e;
      --red:#ef4444;
      --amber:#f59e0b;
      --radius:26px;
      --shadow:0 18px 40px rgba(0,0,0,.08);
      --shadow2:0 10px 26px rgba(0,0,0,.10);
      --hair:rgba(0,0,0,.08);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:-apple-system,BlinkMacSystemFont,"SF Pro Text",system-ui,sans-serif;
      background:var(--bg);
      color:var(--ink);
    }
    .wrap{max-width:1200px;margin:0 auto;padding:24px 18px 80px}
    .topbar{
      display:flex;align-items:flex-start;justify-content:space-between;gap:16px;
      padding:6px 2px 16px;
    }
    .brand{
      font-weight:900;
      font-size:clamp(1.8rem,2.5vw,2.6rem);
      background:linear-gradient(90deg,#0071e3,#34c759);
      -webkit-background-clip:text;background-clip:text;color:transparent;
      letter-spacing:-.02em;
    }
    .sub{
      color:var(--muted);font-size:.95rem;line-height:1.25;margin-top:4px;
    }
    .rt{
      text-align:right;
      color:var(--muted);
      font-size:.92rem;
      line-height:1.3;
    }

    /* Nav */
    .nav{
      display:flex;gap:10px;flex-wrap:wrap;align-items:center;
      margin:10px 0 14px;
    }
    .navbtn{
      display:flex;align-items:center;gap:10px;
      border:1px solid var(--hair);
      background:var(--card);
      border-radius:999px;
      padding:10px 14px;
      box-shadow:var(--shadow2);
      cursor:pointer;
      font-weight:900;
      color:var(--ink);
      text-decoration:none;
      transition:transform .12s ease;
    }
    .navbtn:active{transform:scale(.98)}
    .pill{
      width:34px;height:34px;border-radius:12px;
      display:flex;align-items:center;justify-content:center;
      background:rgba(0,113,227,.10);
      color:var(--blue);
      font-size:1.1rem;
    }

    /* Slot chips */
    .slotsCard{
      background:var(--card); border:1px solid var(--hair);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:16px;
      display:flex;gap:12px;flex-wrap:wrap;align-items:center;justify-content:space-between;
    }
    .slotRow{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .chip{
      border:1px solid var(--hair);
      background:#fff;
      border-radius:999px;
      padding:10px 12px;
      display:flex;gap:10px;align-items:center;
      cursor:pointer;
      transition:transform .12s ease, box-shadow .12s ease;
      box-shadow:0 8px 18px rgba(0,0,0,.05);
      user-select:none;
      font-weight:900;
    }
    .chip:active{transform:scale(.985)}
    .chip.active{
      border-color:rgba(0,113,227,.25);
      background:linear-gradient(180deg,rgba(0,113,227,.10),#fff);
      box-shadow:0 12px 22px rgba(0,113,227,.18);
    }
    .chip .tag{
      font-size:.85rem;color:var(--muted);font-weight:800;
    }
    .badge{
      min-width:30px;height:26px;border-radius:999px;
      display:flex;align-items:center;justify-content:center;
      padding:0 10px;
      background:rgba(34,197,94,.12);
      color:#0f7a3b;
      font-weight:1000;
      font-size:.9rem;
    }
    .chip .auto{
      background:rgba(0,0,0,.06);
      color:var(--ink);
    }

    /* Controls */
    .controls{
      display:flex;gap:10px;flex-wrap:wrap;align-items:center;
      margin-top:12px;
    }
    input{
      border:1px solid var(--hair);
      background:#fff;
      padding:12px 14px;
      border-radius:16px;
      outline:none;
      min-width:220px;
      box-shadow:0 10px 22px rgba(0,0,0,.06);
    }
    input::placeholder{color:rgba(110,110,115,.9)}
    .hint{color:var(--muted);font-size:.92rem}

    /* Resident cards */
    .list{
      margin-top:14px;
      display:flex;flex-direction:column;gap:12px;
    }
    .residentCard{
      background:var(--card);
      border:1px solid var(--hair);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .residentHead{
      display:flex;align-items:center;justify-content:space-between;gap:12px;
      padding:14px 16px;
      border-bottom:1px solid rgba(0,0,0,.06);
      cursor:pointer;
      user-select:none;
    }
    .residentLeft{display:flex;align-items:center;gap:12px}
    .residentIcon{
      width:44px;height:44px;border-radius:16px;
      display:flex;align-items:center;justify-content:center;
      background:rgba(0,113,227,.10);
      color:var(--blue);
      font-size:1.2rem;
      flex:0 0 auto;
    }
    .residentName{
      font-weight:1000;
      font-size:1.05rem;
      letter-spacing:-.01em;
    }
    .residentMeta{color:var(--muted);font-size:.92rem;margin-top:2px}
    .headBtns{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .miniBtn{
      border:1px solid var(--hair);
      background:#fff;
      padding:10px 12px;
      border-radius:999px;
      cursor:pointer;
      font-weight:900;
      box-shadow:0 8px 18px rgba(0,0,0,.06);
    }
    .miniBtn.primary{
      border-color:rgba(0,113,227,.22);
      background:linear-gradient(180deg,rgba(0,113,227,.10),#fff);
    }
    .caret{color:var(--muted);font-weight:900}

    .rows{padding:10px 10px 14px}
    table{width:100%;border-collapse:separate;border-spacing:0 10px}
    td{padding:0}
    .row{
      border:1px solid rgba(0,0,0,.08);
      border-radius:18px;
      box-shadow:0 10px 22px rgba(0,0,0,.06);
      background:#fff;
      overflow:hidden;
    }
    .rowInner{
      display:grid;
      grid-template-columns: 54px 1.3fr 1.6fr 1fr 120px;
      gap:0;
      align-items:stretch;
    }
    .cell{padding:12px 12px;display:flex;flex-direction:column;justify-content:center}
    .cell + .cell{border-left:1px solid rgba(0,0,0,.06)}
    .chk{
      display:flex;align-items:center;justify-content:center;
    }
    .cb{width:18px;height:18px;accent-color:var(--blue)}
    .medName{font-weight:1000}
    .small{color:var(--muted);font-size:.92rem;line-height:1.25;margin-top:3px}
    .timing{font-weight:1000;color:var(--muted)}
    .actBtn{
      height:100%;
      border:none;
      cursor:pointer;
      font-weight:1000;
      color:var(--ink);
      background:linear-gradient(180deg,rgba(34,197,94,.12),#fff);
    }
    .actBtn:hover{filter:brightness(.99)}
    .actBtn:active{transform:scale(.99)}
    .actBtnWrap{height:100%}

    /* Bottom action bar */
    .footerBar{
      position:fixed;left:0;right:0;bottom:0;
      background:rgba(245,245,247,.82);
      backdrop-filter: blur(10px);
      border-top:1px solid rgba(0,0,0,.08);
      padding:10px 14px;
    }
    .footerInner{
      max-width:1200px;margin:0 auto;
      display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap;
    }
    .toast{
      border:1px solid rgba(0,0,0,.08);
      background:#fff;
      border-radius:16px;
      padding:10px 12px;
      box-shadow:0 12px 26px rgba(0,0,0,.10);
      color:var(--muted);
      max-width:720px;
    }
    .ok{color:var(--green);font-weight:1000}
    .warn{color:var(--amber);font-weight:1000}
    .danger{color:var(--red);font-weight:1000}

    .bigBtn{
      border:1px solid rgba(0,0,0,.10);
      background:#fff;
      padding:12px 14px;
      border-radius:999px;
      cursor:pointer;
      font-weight:1000;
      box-shadow:var(--shadow2);
      display:flex;align-items:center;gap:10px;
    }
    .bigBtn.primary{
      border-color:rgba(0,113,227,.22);
      background:linear-gradient(180deg,rgba(0,113,227,.12),#fff);
    }
    .bigBtn:active{transform:scale(.985)}
    .countPill{
      min-width:34px;height:26px;border-radius:999px;
      display:flex;align-items:center;justify-content:center;
      padding:0 10px;
      background:rgba(0,113,227,.10);
      color:var(--blue);
      font-weight:1000;
    }

    /* Modal */
    .modalBack{
      position:fixed;inset:0;
      background:rgba(0,0,0,.30);
      display:none;align-items:center;justify-content:center;
      padding:18px;
      z-index:50;
    }
    .modal{
      width:min(820px, 96vw);
      background:#fff;
      border-radius:28px;
      box-shadow:0 30px 80px rgba(0,0,0,.25);
      overflow:hidden;
      border:1px solid rgba(255,255,255,.35);
    }
    .modalTop{
      padding:16px 18px;
      display:flex;align-items:flex-start;justify-content:space-between;gap:14px;
      border-bottom:1px solid rgba(0,0,0,.08);
      background:linear-gradient(180deg,rgba(0,113,227,.08),#fff);
    }
    .modalTitle{font-weight:1000;font-size:1.15rem}
    .modalSub{color:var(--muted);font-size:.95rem;margin-top:4px}
    .x{
      border:1px solid rgba(0,0,0,.10);
      background:#fff;
      width:40px;height:40px;border-radius:14px;
      cursor:pointer;font-weight:1000;
      box-shadow:0 10px 22px rgba(0,0,0,.10);
    }
    .modalBody{padding:14px 18px}
    .selList{display:flex;flex-direction:column;gap:10px;max-height:45vh;overflow:auto;padding-right:4px}
    .selItem{
      border:1px solid rgba(0,0,0,.08);
      border-radius:18px;
      padding:12px 12px;
      box-shadow:0 10px 22px rgba(0,0,0,.06);
    }
    .selItem .t{font-weight:1000}
    .selItem .s{color:var(--muted);margin-top:3px;font-size:.92rem;line-height:1.25}
    .modalBot{
      padding:14px 18px;
      border-top:1px solid rgba(0,0,0,.08);
      display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;
      background:rgba(245,245,247,.6);
    }

    /* Hold-to-confirm button */
    .holdBtn{
      position:relative;
      border:1px solid rgba(0,0,0,.10);
      background:#fff;
      padding:12px 16px;
      border-radius:999px;
      cursor:pointer;
      font-weight:1000;
      box-shadow:0 10px 26px rgba(0,0,0,.10);
      overflow:hidden;
      user-select:none;
      display:flex;align-items:center;gap:10px;
    }
    .holdBtn.primary{
      border-color:rgba(34,197,94,.30);
      background:linear-gradient(180deg,rgba(34,197,94,.16),#fff);
    }
    .holdFill{
      position:absolute;left:0;top:0;bottom:0;width:0%;
      background:rgba(34,197,94,.22);
      pointer-events:none;
      transition:width .05s linear;
    }
    .holdTxt{position:relative;z-index:1}
    .mutedLine{color:var(--muted);font-size:.92rem}

    @media (max-width:900px){
      .rowInner{grid-template-columns:54px 1.3fr 1.6fr 1fr 110px}
    }
    @media (max-width:740px){
      input{min-width:160px;flex:1}
      .rowInner{grid-template-columns:54px 1.2fr 1.4fr 1fr 98px}
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div>
        <div class="brand">LTC Dispense</div>
        <div class="sub">Shows only meds due for the selected slot. Completed meds are archived automatically.</div>
      </div>
      <div class="rt" id="rt">‚Äî</div>
    </div>

    <div class="nav">
      <span class="navbtn" style="cursor:default">
        <span class="pill">üíä</span> Dispense
      </span>
      <a class="navbtn" href="add.html">
        <span class="pill">‚ûï</span> Add Rx
      </a>
      <button class="navbtn" onclick="hardRefresh()">
        <span class="pill">üîÑ</span> Refresh
      </button>
      <button class="navbtn" onclick="clearSelection()">
        <span class="pill">üßπ</span> Clear
      </button>
    </div>

    <div class="slotsCard">
      <div class="slotRow" id="slotRow"></div>
      <div class="hint" id="slotHint">AUTO: AM 06‚Äì11 ‚Ä¢ NOON 12‚Äì13 ‚Ä¢ PM 14‚Äì17 ‚Ä¢ HS 18‚Äì23 ‚Ä¢ NIGHT 00‚Äì05</div>
    </div>

    <div class="controls">
      <input id="nurse" placeholder="Nurse name (required for log)" />
      <input id="search" placeholder="Search resident / medication / instructions..." oninput="render()" />
      <span class="hint" id="stat">‚Äî</span>
    </div>

    <div class="list" id="list"></div>
  </div>

  <!-- Bottom bar -->
  <div class="footerBar">
    <div class="footerInner">
      <div class="toast" id="toast">Ready.</div>
      <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center">
        <button class="bigBtn" onclick="clearSelection()">Clear</button>
        <button class="bigBtn primary" onclick="openConfirm()">
          Dispense Selected <span class="countPill" id="selCount">0</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Confirm modal -->
  <div class="modalBack" id="modalBack" role="dialog" aria-modal="true">
    <div class="modal">
      <div class="modalTop">
        <div>
          <div class="modalTitle">Confirm Dispense</div>
          <div class="modalSub" id="modalSub">‚Äî</div>
        </div>
        <button class="x" onclick="closeConfirm()">‚úï</button>
      </div>

      <div class="modalBody">
        <div class="selList" id="selList"></div>
      </div>

      <div class="modalBot">
        <div class="mutedLine">Hold the green button to confirm (prevents mis-click).</div>
        <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center">
          <button class="bigBtn" onclick="closeConfirm()">Cancel</button>

          <button class="holdBtn primary" id="holdBtn">
            <span class="holdFill" id="holdFill"></span>
            <span class="holdTxt">Hold to Dispense</span>
          </button>
        </div>
      </div>
    </div>
  </div>

<script>
/*** YOU MUST SET THESE ***/
const API_URL = "https://script.google.com/macros/s/AKfycbyoUMqa0N9B_6yTqA3bpKt4DfzUhamdvgkHw6TxaGYLUwWu72DLOnJ7sIEmNhoMSVCk/exec";
const API_KEY = "CHANGE_ME_TO_SOMETHING_SECRET";

/*** Slot config ***/
const SLOTS = ["AUTO","AM","NOON","PM","HS","NIGHT"];
const SLOT_EMOJI = { AUTO:"ü™Ñ", AM:"üåÖ", NOON:"üïõ", PM:"üåá", HS:"üåô", NIGHT:"üåå" };

/*** State ***/
let modeSlot = "AUTO";          // user selection (AUTO or fixed)
let effectiveSlot = "AM";       // computed slot when AUTO
let counts = { AM:0, NOON:0, PM:0, HS:0, NIGHT:0 };
let items = [];                 // meds due for effective slot
let selected = new Set();       // selected IDs
let expandedResidents = new Set(); // expanded accordions

/*** Utils ***/
const pad = n => String(n).padStart(2,"0");
const todayISO = () => {
  const d = new Date();
  return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
};
const nowStr = () => {
  const d = new Date();
  return `${todayISO()} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
};
function detectSlot(d){
  const h = d.getHours();
  if (h>=6 && h<=11) return "AM";
  if (h>=12 && h<=13) return "NOON";
  if (h>=14 && h<=17) return "PM";
  if (h>=18 && h<=23) return "HS";
  return "NIGHT";
}
function esc(s){
  return String(s||"")
    .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
    .replaceAll('"',"&quot;").replaceAll("'","&#039;");
}
function toast(msg, cls=""){
  const t = document.getElementById("toast");
  t.className = "toast " + (cls||"");
  t.textContent = msg;
}
function updateRT(){
  document.getElementById("rt").textContent = `Now: ${nowStr()} ‚Ä¢ Slot: ${effectiveSlot}`;
}
setInterval(updateRT, 1000);

/*** JSONP (bypasses CORS) ***/
function jsonp(url){
  return new Promise((resolve, reject) => {
    const cb = "cb_" + Math.random().toString(36).slice(2);
    const sep = url.includes("?") ? "&" : "?";
    const full = url + sep + "callback=" + cb;

    const script = document.createElement("script");
    script.src = full;
    script.async = true;

    const timeout = setTimeout(() => {
      cleanup();
      reject(new Error("API timeout"));
    }, 20000);

    window[cb] = (data) => { cleanup(); resolve(data); };
    script.onerror = () => { cleanup(); reject(new Error("API load error")); };

    function cleanup(){
      clearTimeout(timeout);
      delete window[cb];
      script.remove();
    }
    document.head.appendChild(script);
  });
}
function api(action, params={}){
  const q = new URLSearchParams({ action, key: API_KEY, ...params }).toString();
  return jsonp(`${API_URL}?${q}`);
}

/*** UI: slot chips ***/
function slotChipHTML(slot){
  const active = (modeSlot===slot) ? "active" : "";
  const count = (slot==="AUTO") ? (counts[effectiveSlot] ?? 0) : (counts[slot] ?? 0);
  const badgeClass = (slot==="AUTO") ? "badge auto" : "badge";
  return `
    <div class="chip ${active}" data-slot="${slot}">
      <div style="font-size:1.05rem">${SLOT_EMOJI[slot] || "‚è±Ô∏è"}</div>
      <div style="display:flex;flex-direction:column;line-height:1.05">
        <div>${slot}</div>
        <div class="tag">${slot==="AUTO" ? "auto picks now" : "due now"}</div>
      </div>
      <div class="${badgeClass}">${count}</div>
    </div>
  `;
}
function renderSlots(){
  const row = document.getElementById("slotRow");
  row.innerHTML = SLOTS.map(slotChipHTML).join("");
  row.querySelectorAll(".chip").forEach(ch => {
    ch.addEventListener("click", () => {
      modeSlot = ch.dataset.slot;
      selected.clear();
      renderSlots();
      refresh();
    });
  });
}

/*** Group by resident ***/
function groupByResident(list){
  const map = new Map();
  list.forEach(it => {
    const key = (it.resident || "Unknown").trim() || "Unknown";
    if (!map.has(key)) map.set(key, []);
    map.get(key).push(it);
  });
  // Sort meds inside resident
  for (const [k, arr] of map.entries()){
    arr.sort((a,b)=>(a.medication||"").localeCompare(b.medication||""));
  }
  return Array.from(map.entries()).sort((a,b)=>a[0].localeCompare(b[0]));
}

function selectedCount(){
  return selected.size;
}
function updateSelectedPill(){
  document.getElementById("selCount").textContent = String(selectedCount());
}

function setAllForResident(resName, on){
  const meds = items.filter(x => (x.resident||"").trim() === resName);
  meds.forEach(m => {
    if (on) selected.add(m.id);
    else selected.delete(m.id);
  });
  render(); // re-render to sync checkboxes
}

function toggleResidentExpand(resName){
  if (expandedResidents.has(resName)) expandedResidents.delete(resName);
  else expandedResidents.add(resName);
  render();
}

function render(){
  const q = (document.getElementById("search").value||"").toLowerCase().trim();

  const filtered = !q ? items : items.filter(it => {
    return (it.resident||"").toLowerCase().includes(q) ||
           (it.medication||"").toLowerCase().includes(q) ||
           (it.instructions||"").toLowerCase().includes(q) ||
           (it.timing||"").toLowerCase().includes(q);
  });

  const groups = groupByResident(filtered);

  const listEl = document.getElementById("list");
  if (!filtered.length){
    listEl.innerHTML = `
      <div class="residentCard">
        <div class="residentHead" style="cursor:default">
          <div class="residentLeft">
            <div class="residentIcon">‚úÖ</div>
            <div>
              <div class="residentName">No meds due</div>
              <div class="residentMeta">Nothing scheduled for ${effectiveSlot} today.</div>
            </div>
          </div>
        </div>
      </div>`;
    document.getElementById("stat").textContent = `0 due ‚Ä¢ ${effectiveSlot} ‚Ä¢ ${todayISO()}`;
    updateSelectedPill();
    return;
  }

  listEl.innerHTML = groups.map(([resName, meds]) => {
    const isOpen = expandedResidents.has(resName);
    const selInRes = meds.filter(m=>selected.has(m.id)).length;
    const headMeta = `${meds.length} due ‚Ä¢ ${selInRes} selected`;

    const rowsHTML = meds.map(m => {
      const checked = selected.has(m.id) ? "checked" : "";
      return `
        <tr><td class="row">
          <div class="rowInner" data-id="${esc(m.id)}">
            <div class="cell chk">
              <input class="cb" type="checkbox" data-id="${esc(m.id)}" ${checked}>
            </div>
            <div class="cell">
              <div class="medName">${esc(m.medication)}</div>
              <div class="small">${esc(m.instructions || "‚Äî")}</div>
            </div>
            <div class="cell">
              <div class="medName">Timing</div>
              <div class="small">${esc(m.timing || "‚Äî")}</div>
            </div>
            <div class="cell">
              <div class="medName">Due date</div>
              <div class="small">${esc(m.dueDate || todayISO())}</div>
            </div>
            <div class="actBtnWrap">
              <button class="actBtn" data-one="${esc(m.id)}">Dispense</button>
            </div>
          </div>
        </td></tr>
      `;
    }).join("");

    return `
      <div class="residentCard">
        <div class="residentHead" data-res="${esc(resName)}">
          <div class="residentLeft">
            <div class="residentIcon">üë§</div>
            <div>
              <div class="residentName">${esc(resName)}</div>
              <div class="residentMeta">${esc(headMeta)}</div>
            </div>
          </div>
          <div class="headBtns">
            <button class="miniBtn" data-selall="${esc(resName)}">Select all</button>
            <button class="miniBtn" data-unsel="${esc(resName)}">Unselect</button>
            <button class="miniBtn primary" data-open="${esc(resName)}">${isOpen ? "Hide" : "Show"}</button>
            <div class="caret">${isOpen ? "‚ñæ" : "‚ñ∏"}</div>
          </div>
        </div>
        ${isOpen ? `<div class="rows"><table>${rowsHTML}</table></div>` : ""}
      </div>
    `;
  }).join("");

  // Hook up buttons
  listEl.querySelectorAll("[data-open]").forEach(btn=>{
    btn.addEventListener("click",(e)=>{
      e.stopPropagation();
      toggleResidentExpand(btn.dataset.open);
    });
  });
  listEl.querySelectorAll(".residentHead").forEach(head=>{
    head.addEventListener("click",(e)=>{
      const res = head.dataset.res;
      if (!res) return;
      toggleResidentExpand(res);
    });
  });
  listEl.querySelectorAll("[data-selall]").forEach(btn=>{
    btn.addEventListener("click",(e)=>{
      e.stopPropagation();
      setAllForResident(btn.dataset.selall, true);
    });
  });
  listEl.querySelectorAll("[data-unsel]").forEach(btn=>{
    btn.addEventListener("click",(e)=>{
      e.stopPropagation();
      setAllForResident(btn.dataset.unsel, false);
    });
  });

  // Checkbox changes
  listEl.querySelectorAll(".cb").forEach(cb=>{
    cb.addEventListener("change",()=>{
      const id = cb.dataset.id;
      if (!id) return;
      if (cb.checked) selected.add(id); else selected.delete(id);
      updateSelectedPill();
    });
  });

  // One-dispense buttons
  listEl.querySelectorAll("[data-one]").forEach(b=>{
    b.addEventListener("click",(e)=>{
      e.stopPropagation();
      selected.clear();
      selected.add(b.dataset.one);
      updateSelectedPill();
      openConfirm();
    });
  });

  document.getElementById("stat").textContent =
    `${filtered.length} due ‚Ä¢ ${effectiveSlot} ‚Ä¢ ${todayISO()} ‚Ä¢ Residents: ${groups.length}`;

  updateSelectedPill();
}

/*** Data loading ***/
async function refresh(){
  try{
    effectiveSlot = (modeSlot==="AUTO") ? detectSlot(new Date()) : modeSlot;
    updateRT();
    toast("Loading‚Ä¶");

    // counts (fast summary)
    const cRes = await api("getCounts", { date: todayISO() });
    if (cRes.ok && cRes.data) counts = cRes.data;

    renderSlots();

    // meds for slot
    const mRes = await api("getMeds", { slot: effectiveSlot, date: todayISO() });
    if (!mRes.ok) throw new Error(mRes.message || "API error");
    items = Array.isArray(mRes.data) ? mRes.data : [];

    // Auto-expand residents if only a few
    const groupCount = groupByResident(items).length;
    if (expandedResidents.size === 0 && groupCount <= 4) {
      groupByResident(items).forEach(([r]) => expandedResidents.add(r));
    }

    render();
    toast(`Loaded ${items.length} due item(s) for ${effectiveSlot}.`, items.length ? "ok" : "warn");
  } catch(e){
    toast("Error: " + e.message, "warn");
  }
}

function hardRefresh(){
  // keep expanded residents, but clear selection
  selected.clear();
  updateSelectedPill();
  refresh();
}

function clearSelection(){
  selected.clear();
  updateSelectedPill();
  toast("Selection cleared.");
}

/*** Confirm modal + hold-to-dispense ***/
function openConfirm(){
  if (selected.size === 0) return toast("Select at least 1 medication.", "warn");
  const nurse = (document.getElementById("nurse").value||"").trim();
  if (!nurse) return toast("Enter nurse name first.", "warn");

  const chosen = items.filter(x => selected.has(x.id));
  if (!chosen.length) return toast("Selected items are not in the current slot list (refresh).", "warn");

  document.getElementById("modalSub").textContent =
    `Slot: ${effectiveSlot} ‚Ä¢ Nurse: ${nurse} ‚Ä¢ Items: ${chosen.length}`;

  document.getElementById("selList").innerHTML = chosen.map(x => `
    <div class="selItem">
      <div class="t">${esc(x.resident)} ‚Äî ${esc(x.medication)}</div>
      <div class="s">${esc(x.instructions || "‚Äî")}</div>
      <div class="s">Timing: ${esc(x.timing || "‚Äî")}</div>
    </div>
  `).join("");

  document.getElementById("modalBack").style.display = "flex";
}

function closeConfirm(){
  document.getElementById("modalBack").style.display = "none";
  resetHold();
}

let holdTimer = null;
let holdStart = 0;
const HOLD_MS = 900;

function resetHold(){
  const fill = document.getElementById("holdFill");
  fill.style.width = "0%";
  if (holdTimer) { clearInterval(holdTimer); holdTimer = null; }
  holdStart = 0;
}

async function runDispense(){
  const nurse = (document.getElementById("nurse").value||"").trim();
  const ids = Array.from(selected);

  toast("Dispensing‚Ä¶");
  try{
    const res = await api("dispense", { ids: ids.join(","), nurse, slot: effectiveSlot });
    if (!res.ok) throw new Error(res.message || "Dispense failed");
    closeConfirm();
    toast(res.message || "Dispensed.", "ok");
    selected.clear();
    updateSelectedPill();
    await refresh();
  } catch(e){
    toast("Error: " + e.message, "warn");
  }
}

// Hold-to-confirm behavior
const holdBtn = document.getElementById("holdBtn");
holdBtn.addEventListener("pointerdown", () => {
  resetHold();
  holdStart = performance.now();

  holdTimer = setInterval(() => {
    const elapsed = performance.now() - holdStart;
    const pct = Math.min(100, (elapsed / HOLD_MS) * 100);
    document.getElementById("holdFill").style.width = pct + "%";
    if (elapsed >= HOLD_MS) {
      resetHold();
      runDispense();
    }
  }, 20);
});
["pointerup","pointerleave","pointercancel"].forEach(evt=>{
  holdBtn.addEventListener(evt, () => resetHold());
});

// Close modal on backdrop click
document.getElementById("modalBack").addEventListener("click",(e)=>{
  if (e.target.id === "modalBack") closeConfirm();
});

/*** Auto slot switching every minute when AUTO ***/
setInterval(()=>{
  if (modeSlot !== "AUTO") return;
  const newSlot = detectSlot(new Date());
  if (newSlot !== effectiveSlot) {
    effectiveSlot = newSlot;
    selected.clear();
    toast(`Auto-switched to ${effectiveSlot}. Refreshing‚Ä¶`, "ok");
    refresh();
  }
}, 60000);

// Initial
effectiveSlot = detectSlot(new Date());
renderSlots();
refresh();
</script>
</body>
</html>
