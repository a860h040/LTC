<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>LTC Med Dispense</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    :root{
      --bg:#f5f5f7;
      --card-bg:#ffffff;
      --text-main:#1d1d1f;
      --text-sub:#6e6e73;
      --accent-blue:#0071e3;
      --accent-green:#22c55e;
      --shadow-soft:0 18px 40px rgba(0,0,0,.08);
      --shadow-mini:0 10px 26px rgba(0,0,0,.10);
      --radius:26px;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      font-family:-apple-system,BlinkMacSystemFont,"SF Pro Text",system-ui,sans-serif;
      background:var(--bg); color:var(--text-main);
    }
    a{color:var(--accent-blue);text-decoration:none}

    .header{
      padding:28px 7vw 14px;
      display:flex;justify-content:space-between;gap:16px;align-items:flex-start;
    }
    .logo{
      font-size:clamp(1.8rem,2.6vw,2.6rem);
      font-weight:800;
      background:linear-gradient(90deg,#0071e3,#34c759);
      -webkit-background-clip:text; background-clip:text; color:transparent;
    }
    .right{text-align:right;font-size:.95rem;line-height:1.25}
    .right p:first-child{font-weight:700;margin-bottom:4px}
    .right p:last-child{color:var(--text-sub)}

    .nav{
      padding:0 7vw 18px;
      display:flex;flex-wrap:wrap;gap:12px;align-items:center;
    }
    .nav-item{
      border:none;background:transparent;cursor:pointer;
      display:flex;flex-direction:column;align-items:center;gap:6px;
      min-width:92px;transition:transform .15s ease;
      color:var(--text-main);font-size:.82rem;
    }
    .nav-item:hover{transform:translateY(-1px)}
    .nav-icon{
      width:64px;height:64px;border-radius:18px;background:#fff;
      box-shadow:0 8px 22px rgba(0,0,0,.07);
      display:flex;align-items:center;justify-content:center;font-size:1.85rem;
    }
    .nav-item span{color:var(--text-sub)}
    .nav-item.active .nav-icon{background:var(--accent-green);color:#fff}
    .nav-item.active span{color:var(--accent-green);font-weight:700}
    .nav-item.dark .nav-icon{background:#111827;color:#fff}

    main{padding:0 7vw 34px}
    .headline{
      font-size:clamp(1.35rem,1.9vw,1.75rem);
      font-weight:700;margin:6px 0 14px;
    }
    .headline span{color:var(--accent-blue)}

    .card{
      background:var(--card-bg);
      border-radius:var(--radius);
      box-shadow:var(--shadow-soft);
      overflow:hidden;
    }
    .top{
      padding:16px 18px;border-bottom:1px solid rgba(0,0,0,.06);
      display:flex;flex-wrap:wrap;gap:12px;align-items:center;justify-content:space-between;
    }
    .controls{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
    select,input{
      border:1px solid rgba(0,0,0,.12);
      background:#fff;padding:11px 12px;border-radius:14px;
      min-width:210px;outline:none;
    }
    input::placeholder{color:rgba(110,110,115,.9)}
    .mini{font-size:.9rem;color:var(--text-sub)}

    .wrap{overflow:auto}
    table{width:100%;border-collapse:collapse}
    th,td{padding:14px 12px;border-bottom:1px solid rgba(0,0,0,.06);text-align:left;vertical-align:top}
    th{
      font-size:.78rem;color:var(--text-sub);
      text-transform:uppercase;letter-spacing:.08em;
      background:rgba(245,245,247,.6);
      position:sticky;top:0;z-index:2;
    }
    tr.row{cursor:pointer}
    tr.row:hover td{background:rgba(0,0,0,.018)}
    tr.row.selected td{background:rgba(0,113,227,.06)}
    .title{font-weight:800}
    .muted{color:var(--text-sub)}

    .checkwrap{
      display:inline-flex;align-items:center;justify-content:center;
      width:38px;height:38px;border-radius:12px;border:1px solid rgba(0,0,0,.10);
      background:#fff;box-shadow:0 6px 16px rgba(0,0,0,.06);
    }
    .cb{width:18px;height:18px;accent-color:var(--accent-blue);cursor:pointer}

    .rowBtn{
      border:1px solid rgba(0,0,0,.10);
      background:#fff;padding:10px 12px;border-radius:999px;
      cursor:pointer;font-weight:800;box-shadow:var(--shadow-mini);
      white-space:nowrap;
    }
    .rowBtn.primary{
      border-color:rgba(0,113,227,.22);
      background:linear-gradient(180deg,rgba(0,113,227,.10),#fff);
    }

    .bottom{
      padding:14px 18px;display:flex;flex-wrap:wrap;gap:10px;
      align-items:center;justify-content:space-between;
      background:rgba(245,245,247,.45);
    }
    .btns{display:flex;flex-wrap:wrap;gap:10px}
    .btn{
      border:1px solid rgba(0,0,0,.10);background:#fff;
      padding:11px 14px;border-radius:999px;cursor:pointer;
      font-weight:800;box-shadow:var(--shadow-mini);
    }
    .btn.primary{
      border-color:rgba(0,113,227,.22);
      background:linear-gradient(180deg,rgba(0,113,227,.10),#fff);
    }

    .msg{
      font-size:.95rem;color:var(--text-sub);
      padding:10px 12px;border-radius:14px;background:#fff;
      border:1px solid rgba(0,0,0,.08);
      box-shadow:0 8px 22px rgba(0,0,0,.06);
      max-width:760px;
    }
    .ok{color:var(--accent-green);font-weight:900}
    .warn{color:#b45309;font-weight:900}

    @media (max-width:720px){
      .header,.nav,main{padding-left:5vw;padding-right:5vw}
      select,input{min-width:170px;flex:1}
    }
  </style>
</head>

<body>
  <div class="header">
    <div class="logo">LTC Med Dispense</div>
    <div class="right">
      <p id="rt">Live queue</p>
      <p id="rs">Auto filters by slot</p>
    </div>
  </div>

  <div class="nav">
    <button class="nav-item active" onclick="refresh()">
      <div class="nav-icon">ðŸ’Š</div><span>Dispense</span>
    </button>

    <a class="nav-item dark" href="add.html">
      <div class="nav-icon">âž•</div><span>Add Rx</span>
    </a>

    <button class="nav-item" onclick="refresh()">
      <div class="nav-icon">ðŸ”„</div><span>Refresh</span>
    </button>

    <button class="nav-item" onclick="clearSelection()">
      <div class="nav-icon">ðŸ§¹</div><span>Clear</span>
    </button>
  </div>

  <main>
    <div class="headline"><span>Smart queue.</span> Only shows meds due right now.</div>

    <section class="card">
      <div class="top">
        <div class="controls">
          <select id="slotSelect" onchange="refresh()">
            <option value="AUTO">AUTO (based on time)</option>
            <option value="AM">AM</option>
            <option value="NOON">NOON</option>
            <option value="PM">PM</option>
            <option value="HS">HS</option>
            <option value="NIGHT">NIGHT</option>
          </select>

          <input id="nurse" placeholder="Nurse name (for log)" />
          <input id="search" placeholder="Search resident / medication..." oninput="renderFiltered()" />
        </div>

        <div class="mini" id="info">â€”</div>
      </div>

      <div class="wrap">
        <table>
          <thead>
            <tr>
              <th style="width:60px"><input type="checkbox" id="all" onchange="toggleAll(this.checked)"></th>
              <th>Resident</th>
              <th>Medication</th>
              <th>Instructions</th>
              <th>Timing</th>
              <th style="width:160px">Action</th>
            </tr>
          </thead>
          <tbody id="tbody">
            <tr><td colspan="6" class="muted">Loadingâ€¦</td></tr>
          </tbody>
        </table>
      </div>

      <div class="bottom">
        <div class="btns">
          <button class="btn primary" onclick="dispenseSelected()">Dispense Selected</button>
          <button class="btn" onclick="clearSelection()">Clear</button>
        </div>
        <div class="msg" id="msg">â€”</div>
      </div>
    </section>
  </main>

<script>
/*** SET THESE 2 VALUES ***/
const API_URL = "https://script.google.com/macros/s/AKfycbyoUMqa0N9B_6yTqA3bpKt4DfzUhamdvgkHw6TxaGYLUwWu72DLOnJ7sIEmNhoMSVCk/exec";
const API_KEY = "CHANGE_ME_TO_SOMETHING_SECRET";

let ALL = [];

function pad(n){ return String(n).padStart(2,"0"); }
function todayISO(){
  const d=new Date();
  return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
}
function timeNow(){
  const d=new Date();
  return `${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
}
function detectSlot(d){
  const h=d.getHours();
  if (h>=6 && h<=11) return "AM";
  if (h>=12 && h<=13) return "NOON";
  if (h>=14 && h<=17) return "PM";
  if (h>=18 && h<=23) return "HS";
  return "NIGHT";
}

function setMsg(text, cls=""){
  const el=document.getElementById("msg");
  el.className="msg "+cls;
  el.textContent=text||"";
}
function updateHeader(slot){
  document.getElementById("rt").textContent = `Live queue â€¢ ${todayISO()} â€¢ ${timeNow()}`;
  document.getElementById("rs").textContent = `Slot: ${slot} (AUTO: AM 06â€“11 â€¢ NOON 12â€“13 â€¢ PM 14â€“17 â€¢ HS 18â€“23 â€¢ NIGHT 00â€“05)`;
  document.getElementById("info").textContent = `Showing: ${slot} â€¢ Date: ${todayISO()}`;
}

/*** JSONP (bypasses CORS) ***/
function jsonp(url){
  return new Promise((resolve, reject) => {
    const cb = "cb_" + Math.random().toString(36).slice(2);
    const sep = url.includes("?") ? "&" : "?";
    const full = url + sep + "callback=" + cb;

    const script = document.createElement("script");
    script.src = full;
    script.async = true;

    const timeout = setTimeout(() => {
      cleanup();
      reject(new Error("API timeout"));
    }, 20000);

    window[cb] = (data) => {
      cleanup();
      resolve(data);
    };

    script.onerror = () => {
      cleanup();
      reject(new Error("API load error"));
    };

    function cleanup(){
      clearTimeout(timeout);
      delete window[cb];
      script.remove();
    }

    document.head.appendChild(script);
  });
}

function api(action, params={}){
  const q = new URLSearchParams({ action, key: API_KEY, ...params }).toString();
  return jsonp(`${API_URL}?${q}`);
}

/*** Render ***/
function escapeHtml(s){
  return String(s||"")
    .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
    .replaceAll('"',"&quot;").replaceAll("'","&#039;");
}

function renderTable(rows){
  const tb=document.getElementById("tbody");
  if (!rows.length){
    tb.innerHTML = `<tr><td colspan="6" class="muted" style="padding:18px 12px;">No medications due for this slot.</td></tr>`;
    return;
  }
  tb.innerHTML = rows.map(r => `
    <tr class="row" data-row="${r.rowNum}">
      <td>
        <span class="checkwrap">
          <input class="cb rowCheck" type="checkbox" data-row="${r.rowNum}">
        </span>
      </td>
      <td><div class="title">${escapeHtml(r.resident||"")}</div></td>
      <td><div class="title">${escapeHtml(r.medication||"")}</div></td>
      <td class="muted">${escapeHtml(r.instructions||"")}</td>
      <td class="muted">${escapeHtml(r.timing||"")}</td>
      <td><button class="rowBtn primary oneDispense" data-row="${r.rowNum}">Dispense</button></td>
    </tr>
  `).join("");
  syncSelectedStyling();
}

function renderFiltered(){
  const q=(document.getElementById("search").value||"").toLowerCase().trim();
  const rows = !q ? ALL : ALL.filter(x =>
    (x.resident||"").toLowerCase().includes(q) ||
    (x.medication||"").toLowerCase().includes(q) ||
    (x.instructions||"").toLowerCase().includes(q) ||
    (x.timing||"").toLowerCase().includes(q)
  );
  renderTable(rows);
}

function syncSelectedStyling(){
  document.querySelectorAll("tr.row").forEach(tr=>{
    const rn=tr.dataset.row;
    const cb=tr.querySelector(`.rowCheck[data-row="${rn}"]`);
    tr.classList.toggle("selected", !!(cb && cb.checked));
  });
}

/*** Selection helpers ***/
function toggleAll(on){
  document.querySelectorAll(".rowCheck").forEach(cb=>cb.checked=on);
  syncSelectedStyling();
}
function clearSelection(){
  document.getElementById("all").checked=false;
  document.querySelectorAll(".rowCheck").forEach(cb=>cb.checked=false);
  syncSelectedStyling();
  setMsg("Selection cleared.");
}
function selectedRowNums(){
  return Array.from(document.querySelectorAll(".rowCheck"))
    .filter(cb=>cb.checked)
    .map(cb=>Number(cb.dataset.row))
    .filter(Boolean);
}

/*** Actions ***/
async function refresh(){
  try{
    setMsg("Loadingâ€¦");
    document.getElementById("all").checked=false;

    const slotMode=document.getElementById("slotSelect").value;
    const slot=(slotMode==="AUTO") ? detectSlot(new Date()) : slotMode;

    updateHeader(slot);

    const res = await api("getMeds", { slot, date: todayISO() });
    if (!res.ok) throw new Error(res.message || "API error");

    ALL = Array.isArray(res.data) ? res.data : [];
    renderFiltered();
    setMsg(`Loaded ${ALL.length} due item(s).`, ALL.length ? "ok" : "warn");
  }catch(e){
    setMsg("Error: "+e.message, "warn");
  }
}

async function dispenseRows(rows){
  if (!rows.length) return setMsg("Select at least 1 medication.", "warn");
  const nurse=(document.getElementById("nurse").value||"").trim();
  if (!nurse) return setMsg("Enter nurse name.", "warn");

  const slotMode=document.getElementById("slotSelect").value;
  const slot=(slotMode==="AUTO") ? detectSlot(new Date()) : slotMode;

  if (!confirm(`Dispense ${rows.length} medication(s) for slot ${slot}?`)) return;

  try{
    setMsg("Dispensingâ€¦");
    const res = await api("dispense", { rows: rows.join(","), nurse, slot });
    if (!res.ok) throw new Error(res.message || "Dispense failed");
    setMsg(res.message || "Done.", "ok");
    await refresh();
  }catch(e){
    setMsg("Error: "+e.message, "warn");
  }
}

function dispenseSelected(){ dispenseRows(selectedRowNums()); }

/*** Row click toggling + one-button dispense ***/
document.getElementById("tbody").addEventListener("click", (e)=>{
  const btn=e.target.closest(".oneDispense");
  if (btn){
    const rn=Number(btn.dataset.row);
    e.preventDefault();
    return dispenseRows([rn]);
  }

  if (e.target.closest(".rowCheck")){
    setTimeout(syncSelectedStyling, 0);
    return;
  }

  const tr=e.target.closest("tr.row");
  if (!tr) return;
  const rn=tr.dataset.row;
  const cb=tr.querySelector(`.rowCheck[data-row="${rn}"]`);
  if (!cb) return;

  cb.checked=!cb.checked;
  syncSelectedStyling();
});

setInterval(()=>{
  const slotMode=document.getElementById("slotSelect").value;
  const slot=(slotMode==="AUTO") ? detectSlot(new Date()) : slotMode;
  updateHeader(slot);
}, 1000);

refresh();
</script>
</body>
</html>
